<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Offline Leaflet Map with Pre-rotated Rover</title>

  <!-- Leaflet local -->
  <link rel="stylesheet" href="leaflet/dist/leaflet.css" />
  <script src="leaflet/dist/leaflet.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      width: 100%;
      margin: 0;
    }

    .marker-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      white-space: nowrap;
      pointer-events: none;
    }

    .marker-label {
      margin-top: 2px;
      color: white;
      font-weight: bold;
      text-shadow: 0 0 3px black;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    console.log("Map loading with pre-rotated rover images...");

    /* ===============================
       üó∫Ô∏è MAP SETUP
    =============================== */
    var map = L.map("map", {
      minZoom: 2,
      maxZoom: 24
    }).setView([12.991600, 80.234600], 16);

    L.tileLayer('OSMPublicTransport/{z}/{x}/{y}.png', {
      maxZoom: 24,
      maxNativeZoom: 19,
      minZoom: 0,
      attribution: 'ANVESHAK'
    }).addTo(map);

    /* ===============================
       üñºÔ∏è ICON DEFINITIONS
    =============================== */
    var iconImages = {
      "red_pickup": "icons/red_cone.png",
      "yellow_pickup": "icons/yellow_cone.png",
      "blue_pickup": "icons/blue_cone.png",
      "green_pickup": "icons/green_cone.png",
      "orange_pickup": "icons/orange_cone.png",
      "purple_pickup": "icons/purple_cone.png",
      "unknown_pickup": "icons/gray_cone.png",
      "red_delivery": "icons/red_cone.png",
      "yellow_delivery": "icons/yellow_cone.png",
      "blue_delivery": "icons/blue_cone.png",
      "green_delivery": "icons/green_cone.png",
      "orange_delivery": "icons/orange_cone.png",
      "purple_delivery": "icons/purple_cone.png",
      "unknown_delivery": "icons/gray_cone.png",
      "waypoint": "icons/waypoint.png"
    };

    var markers = [];
    var currentYaw = 0;

    /* ===============================
       üîÑ ROVER ANGLE FUNCTIONS
    =============================== */
    
    // Get the closest rover image for a given angle
    function getRoverImageForAngle(angleDeg) {
      // Normalize angle to 0-359
      angleDeg = ((angleDeg % 360) + 360) % 360;
      
      // Round to nearest 10 degrees
      var roundedAngle = Math.round(angleDeg / 10) * 10;
      
      // Handle 360 -> 0
      if (roundedAngle >= 360) roundedAngle = 0;
      
      // Format with leading zeros (000, 010, 020, etc.)
      var angleStr = String(roundedAngle).padStart(3, '0');
      
      return `icons/rover_angles/rover_${angleStr}.png`;
    }

    function createIcon(label, zoom) {
      if (!label || label === "NaN") {
        label = "gray_cone";
      }

      var baseSize = 12;
      var scale = zoom / 15;
      scale = Math.max(0.6, Math.min(scale, 1.4));

      var size = baseSize * scale;
      var fontSize = 10 * scale;
      var iconUrl = iconImages[label] || iconImages["gray_cone"];

      var html = `
        <div class="marker-container">
          <img src="${iconUrl}" style="width:${size}px; height:${size}px;" />
          <div class="marker-label" style="font-size:${fontSize}px;">
            ${label}
          </div>
        </div>
      `;

      return L.divIcon({
        html: html,
        className: "",
        iconSize: [size, size + fontSize + 4],
        iconAnchor: [size / 2, size / 2]
      });
    }

    function createRoverIcon(zoom, angleDeg) {
      var baseSize = 48;
      var scale = zoom / 15;
      scale = Math.max(0.6, Math.min(scale, 1.4));
      var size = baseSize * scale;

      // Get the appropriate pre-rotated image
      var iconUrl = getRoverImageForAngle(angleDeg);

      return L.icon({
        iconUrl: iconUrl,
        iconSize: [size, size],
        iconAnchor: [size / 2, size / 2]
      });
    }

    // Create rover marker
    var roverMarker = L.marker(
      [12.992152, 80.232440],
      { icon: createRoverIcon(map.getZoom(), 0) }
    ).addTo(map);

    console.log("‚úì Rover marker created with pre-rotated images");

    /* ===============================
       üéØ UPDATE FUNCTIONS
    =============================== */

    function updateRoverPosition(lat, lon) {
      console.log(`updateRoverPosition: lat=${lat}, lon=${lon}`);
      roverMarker.setLatLng([lat, lon]);
      map.panTo([lat, lon], { animate: true });
    }

    function updateRoverYaw(yawDeg) {
      console.log(`updateRoverYaw: ${yawDeg}¬∞`);
      
      if (yawDeg !== undefined && !isNaN(yawDeg)) {
        currentYaw = yawDeg;        
        var newIcon = createRoverIcon(map.getZoom(), yawDeg);
        roverMarker.setIcon(newIcon);
        
        console.log(`  Using image: ${getRoverImageForAngle(yawDeg)}`);
      }
    }

    function addMarkers(markerList) {
      console.log("Adding markers:", markerList.length);
      markerList.forEach(m => {
        var marker = L.marker(
          [m.lat, m.lon],
          { icon: createIcon(m.label, map.getZoom()) }
        ).addTo(map);

        markers.push({id: m.id ,marker: marker, label: m.label });
      });
    }

    function clearMarkers() {
      console.log("Clearing markers");
      markers.forEach(m => map.removeLayer(m.marker));
      markers = [];
    }
    

    /* ===============================
       üîç ZOOM HANDLER
    =============================== */

    map.on('zoomend', function() {
      var zoom = map.getZoom();
      console.log(`Zoom: ${zoom}, maintaining yaw: ${currentYaw}¬∞`);

      // Update rover icon with current angle
      roverMarker.setIcon(createRoverIcon(zoom, currentYaw));

      // Update other markers
      markers.forEach(m => {
        m.marker.setIcon(createIcon(m.label, zoom));
      });
    });

    /* ===============================
       üåç EXPOSE TO QT
    =============================== */
    window.updateRoverPosition = updateRoverPosition;
    window.updateRoverYaw = updateRoverYaw;
    window.addMarkers = addMarkers;
    window.clearMarkers = clearMarkers;
    window.map = map;
    
    console.log("‚úì Map ready, functions exposed");

  </script>
</body>
</html>